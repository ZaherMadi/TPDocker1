name: Deploy Integration

on:
  workflow_run:
    workflows: ["Publish to GHCR"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Ne s'exécute que si le workflow précédent a réussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    # Permissions pour pull depuis GHCR
    permissions:
      packages: read

    steps:
      # 1. Récupérer le code (pour le docker-compose.yml)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # 2. Login au GHCR pour pull l'image
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Définir l'image Python depuis GHCR (PAS de build local)
      - name: Set Python image from GHCR
        run: |
          REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')
          echo "PYTHON_IMAGE=ghcr.io/${REPO_LOWER}/python-api:${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          echo "Using image: ghcr.io/${REPO_LOWER}/python-api:${{ github.event.workflow_run.head_sha }}"

      # 2bis. Démarrer la stack complète
      - name: Start full stack with docker compose
        run: docker compose up -d
        env:
          PYTHON_IMAGE: ${{ env.PYTHON_IMAGE }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

      # . Attendre que les services démarrent
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 30
          docker compose ps

      # . Vérifier que l'API Python répond
      - name: Test API is responding
        run: |
          curl --retry 5 --retry-delay 3 --retry-connrefused http://localhost:8000/
          echo "API responded successfully!"

      # 4. Vérifier que Nginx proxy vers Python
      - name: Test Nginx proxy to Python API
        run: |
          curl --retry 5 --retry-delay 3 --retry-connrefused http://localhost:8080/
          echo "Nginx proxy working!"
